---
const { id, title } = Astro.props;
const hlsUrl = `http://localhost:3001/hls/${id}/stream.m3u8`;
const uniqueId = `video-${id}-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="camera-feed" data-camera-id={id}>
  <h2>{title}</h2>
  <video
    id={uniqueId}
    class="video-js vjs-default-skin"
    controls
    preload="auto"
    playsinline
  >
  </video>
</div>

<script define:vars={{ uniqueId, hlsUrl, id }}>
  // This script runs for each CameraFeed component instance
  (function () {
    function initPlayer() {
      // Wait for videojs to be available
      if (typeof videojs === "undefined") {
        setTimeout(initPlayer, 100);
        return;
      }

      const videoElement = document.getElementById(uniqueId);
      if (!videoElement) {
        console.error(`Video element not found: ${uniqueId}`);
        return;
      }

      // Check if player already exists
      if (videojs.getPlayers()[uniqueId]) {
        console.log(`Player already initialized for ${id}`);
        return;
      }

      try {
        const player = videojs(uniqueId, {
          controls: true,
          autoplay: true,
          muted: true,
          preload: "auto",
          fluid: true,
          responsive: true,
          liveui: true,
          html5: {
            vhs: {
              overrideNative: true,
              enableLowInitialPlaylist: true,
            },
            nativeVideoTracks: false,
            nativeAudioTracks: false,
            nativeTextTracks: false,
          },
        });

        player.src({
          src: hlsUrl,
          type: "application/x-mpegURL",
        });

        player.ready(function () {
          console.log(`‚úÖ Player ready for ${id}`);
          this.play().catch((err) => {
            console.log(`‚ö†Ô∏è  Autoplay prevented for ${id}:`, err.message);
          });
        });

        player.on("loadeddata", function () {
          console.log(`üì∫ Stream loaded for ${id}`);
        });

        player.on("error", function () {
          const error = player.error();
          console.error(
            `‚ùå Error loading ${id}:`,
            error ? error.message : "Unknown error"
          );
        });

        player.on("playing", function () {
          console.log(`‚ñ∂Ô∏è  Playing ${id}`);
        });
      } catch (error) {
        console.error(`Failed to initialize player for ${id}:`, error);
      }
    }

    // Start initialization when DOM is ready
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initPlayer);
    } else {
      initPlayer();
    }
  })();
</script>

<style>
  .camera-feed {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    background: #000;
    border-radius: 4px;
    overflow: hidden;
    border: 2px solid transparent;
    transition: border-color 0.3s ease;
  }

  .camera-feed:hover {
    border-color: rgba(255, 255, 255, 0.2);
  }

  .camera-feed.active {
    border-color: #4a90e2;
  }

  .camera-feed h2 {
    margin: 0;
    padding: 0.5rem;
    font-size: 0.8rem;
    background: #1a1a1a;
    color: #fff;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    flex-shrink: 0;
  }

  .video-js {
    width: 100%;
    height: 100%;
    flex: 1;
  }

  :global(.video-js .vjs-tech) {
    object-fit: cover;
  }
</style>
